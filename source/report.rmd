---
title: "`r thistitle`"
author: "NYS Department of Environmental Conservation"
date: "`r format(Sys.Date(),format='%B %d, %Y')`"
output:  
  html_document:
    toc: true
    toc_depth: 6
    toc_float: true
---

Just checking to make sure we have only one unique location per lake
```{r, echo=FALSE}
records<-unique(temp[c("LAKE_ID","LOCATION_ID")])
records
rm(records)
```


#Calculations 
##Trophic State
```{r, echo=FALSE,results='asis'}
score<-c(1,2,3)  
clarity<-c('<2','2-5','>5')
TP.surface<-c('>0.02','0.01-0.02','<0.01')
Chla<-c('>8','2-8','<2') 
trophicSubs<-data.frame(score,clarity,TP.surface,Chla)
knitr::kable(trophicSubs) 
rm(list=c('score','clarity','TP.surface','Chla','trophicSubs'))
```

These scores are added together to get a total score
```{r, echo=FALSE,results='asis'}
#trophic state score table
overall.score<-c('3','6 or <6','7 or 8','9')
translation<-c('eutrophic','mesotrophic','mesooligotrophic','oligotrophic')
Trophic<-data.frame(overall.score,translation)
knitr::kable(Trophic) 
rm(list=c('Trophic','overall.score','translation'))
```	


##Public Water Supply Use  
assuming this waterbody is a public water supply    

Components:  
```{r, echo=FALSE,results='asis'}
short<-c('UR','AT','MCL','ChlA','HABs','BGA','sHABs','Bind')
definition<-c('number of days PWS use was restricted','Additional Treatment',
              'any maximum contamination limit violations reported at the public water supply',
              'What percent of the Chl A readings since 2011 (or 2018) exceeded the standard (class AA standard is >4, class A standard is >6)',
              'How many days were HABs observed since 2011 (or 2018)',
              'Surface readings of FP-BGChl over 25 since 2011 (or 2018)','Count of shoreline habs that have FP-BGChl reading over 25 since 2011',
              'Assuming the lake is neither class B or C, The number of Fe, Mn, As hypolimnion samples that exceeded thresholds OR using inferred DO from aquatic life')
components<-data.frame(short,definition)
knitr::kable(components)
rm(list=c('short','definition','components'))
```

Additional definitions:   

* NOTE: inferred DO is calculated in aquatic life table  

Questions for Scott   

* AT: what does this mean exactly and where are data collected from?  
* MCL: how to get this info???  
* sHABs: for 2018 calc it's also since 2011???  
* sHABs: this code seems wrong. I would think they should both be the same spreadsheet (it is in the swimming sHABs): COUNTIFS(RawShoreHAB!$AC$2:$AC$500,">25",RawSurfaceAll!$AP$2:$AP$500,">2011")
* Bind: Why do you only count Fe readings if there are more than one???      
* Bind: the inferred DO value for av year is used but the inferred DO assessment is used for 2018????  
* Bind: Why don't you use Fe, Me, or As values for 2018????????  
* ChlA: Shouldn't ChlA have a -1 value for not being a PWS???   
* ALL: Why are the scores different for 2018 vers av year?  
* ALL: shouldn't y2018 use > and not = for comparing max(PWS)??? 
  
Components for av year:  
```{r, echo=FALSE,results='asis'}
score<-c('-1',0,1.3,2.2,2.3,2.4,2.5,2.6,3.3,3.6,3.7,3.8,3.9,4.9)
UR<-c('not PWS',0,'','','','','','','','','','','0-30','>30')
AT<-c('not PWS','','','','','','','','','','','is PWS','','')
MCL<-c('not PWS','no','','','','','','','','','yes','','','')
ChlA<-c('','<10%','','','','','','10%-50%','','>50%','','','','')
HABs<-c('not PWS',0,'','','','','>0','','','','','','','')
BGA<-c('not PWS',0,'','','','>0','','','','','','','','')
sHABs<-c('not PWS',0,'','>0','','','','','','','','','','')
Bind <-c('','','av As>0.3 OR InferredDO>0','','av Mn>0.1 OR count(Fe>1)>1','','','','count(Fe>10)>1','','','','','')
PWS<-data.frame(score,UR,AT,MCL,ChlA,HABs,BGA,sHABs,Bind)
knitr::kable(PWS)
rm(list=c('PWS','score','UR','AT','MCL','ChlA','HABs','BGA','sHABs','Bind'))
```	

Components for 2018
```{r, echo=FALSE,results='asis'}
score<-c('-1',0,1.5,2.6,2.7,2.8,2.9,3.9)
ChlA<-c('','<10%','','','','','10%-50%','>50%')
HABs<-c('not PWS',0,'','','','>0','','')
BGA<-c('not PWS',0,'','','>0','','','')
sHABs<-c('not PWS',0,'','>0','','','','')
Bind <-c('','','InferredDO>0','','','','','')
PWS<-data.frame(score,ChlA,HABs,BGA,sHABs,Bind)
knitr::kable(PWS)
rm(list=c('PWS','score','ChlA','HABs','BGA','sHABs','Bind'))

```	


Total Score for Potable Water Supplies    
```{r, echo=FALSE,results='asis'}
score<-c(2,3,4,5,6)
translation<-c('Not Known','Supported/Good','Threatened/Fair','Stressed/Poor','Impaired')
avYear<-c('notPWS','0>max(PWS)<1','max(PWS)>1','max(PWS)>2','max(PWS)>3')
y2018<-c('notPWS','0>max(PWS18)<1','max(PWS18)=1','max(PWS18)=2','max(PWS18)=3')
PWSscore<-data.frame(score,translation,avYear,y2018)
knitr::kable(PWSscore)
rm(list=c('score','avYear','PWSscore','translation','y2018'))
```	

Primary Issue  
The primary issue is simply the highest scoring component in the list  

##Swimming  

Components:  
```{r, echo=FALSE,results='asis'}
short<-c('DB','Clarity','Control','sTOX','sHABs','TOX','BGA','CT','HABn')
definition<-c('number of days beaches were closed',
              'Percentage of clarity observations since 2011 (or 2018) less than 1.21',
              'Control measures',
              'Count of shore samples >4 since 2011 (or 2018)',
              'Count of shoreline habs that have FP-BGChl reading over 25 since 2011 (or 2018)',
              'Count of surface samples >4 since 2011 (or 2018)',
              'Surface readings of FP-BGChl over 25 since 2011 (or 2018)',
              'Trend score for clarity since sampling began',
              'Any HAB notification')
components<-data.frame(short,definition)
knitr::kable(components)
rm(list=c('short','definition','components'))
```

Additional definitions/Notes:  

* Trend score = RegScore x Pscore x SIGN
    + RegScore = 0 (if n<5 | r2<0.3), 1 (if 0.03<=r2<0.5), 2 (if r2>=0.5)  
    + PScore = 0 (if n<5 | p>0.05), 1 (if 0.01<p<=0.05), 2 (if p<=0.01)
    + SIGN = 0 (if slope=0), 1 (if slope is +), -1 (if slope is -)
  
Questions for Scott:  

* Control: What would these be? Where is this data collected?  
* sTOX: what is this parameter in the database???  
* HABn: excel descriptor is >1 but the formula looks for any at all  
* HABn: I'm presuming this is the listing on the website?  
* sHABs18: =0 is repeated in this equation: =IF($B$9="no",-1,IF($G$21=0,0,IF($G$21=0,0,IF($G$21=1,1.7,2.7))))
* AvYr: for total score, shouldn't it be 2 if it doesn't have a beach?  

Components for av year: 

```{r, echo=FALSE,results='asis'}
score<-c('-1',0,1.2,1.3,1.4,1.5,1.6,2.1,2.2,2.3,2.4,2.5,2.6,2.8,2.9,3,3.1,3.7,3.8)
DB<-c('','no beach','','','','','','','','','','','','','>10','0<x<10','','','')
Clarity<-c('','<=10','','','','','','','','','','','','>10','','','','','>50')
Control<-c('','no','','','','','','','','','','','','','','','','!no','')
sTOX<-c('no beach','0','','','','','1','','','','','','>1','','','','','','')
sHABs<-c('no beach','0','','','','1','','','','','','>1','','','','','','','')
TOX<-c('','<1','','','1','','','','','','>1','','','','','','','','')
BGA<-c('','<1','','1','','','','','','>1','','','','','','','','','')
CT<-c('','any other score','=2','','','','','','=4','','','','','','','','','','')
HABn<-c('no beach','no','','','','','','only 1','','','','','','','','','>1','','')
SWIM<-data.frame(score,DB,Clarity,Control,sTOX,sHABs,TOX,BGA,CT,HABn)
knitr::kable(SWIM)
rm(list=c('SWIM','score','DB','Clarity','Control','sTOX','sHABs','TOX','BGA','CT','HABn'))
```	

Components for 2018:  

```{r, echo=FALSE,results='asis'}
score<-c('-1','0','1.5','1.6','1.7','1.8','2.4','2.5','2.6','2.7','2.8','3.4','3.9')
Clarity<-c('','<=10','','','','','','','','','>10','','>50')
sTOX<-c('no beach','0','','','','1','','','','','>1','','')
sHABs<-c('no beach','0','','','1','','','','','>1','','','')
TOX<-c('no beach','<1|0','','1','','','','','>1','','','','')
BGA<-c('no beach','<1','1','','','','','>1','','','','','')
HABn<-c('no beach','"no"','','','','','only 1','','','','','>1','')
SWIM18<-data.frame(score,Clarity,sTOX,sHABs,TOX,BGA,HABn)
knitr::kable(SWIM18)
rm(list=c('SWIM18','score','Clarity','sTOX','sHABs','TOX','BGA','HABn'))
```	

Total Score for Swimming  
```{r, echo=FALSE,results='asis'}
score<-c(2,3,4,5,6)
translation<-c('Not Known','Supported/Good','Threatened/Fair','Stressed/Poor','Impaired')
avYear<-c('','0>max(SWIM)<1','max(SWIM)>1','max(SWIM)>2','max(SWIM)>3')
y2018<-c('','0>max(SWIM18)<1','max(SWIM18)=1','max(SWIM18)=2','max(SWIM18)=3')
SwimScore<-data.frame(score,translation,avYear,y2018)
knitr::kable(SwimScore)
rm(list=c('score','avYear','SwimScore','translation','y2018'))
```	

Primary Issue  
The primary issue is simply the highest scoring component in the list  


# Secchi Depth  
Secchi depth data were collected:  

```{r, echo=FALSE}
secchi<-temp[temp$Characteristic.Name=="DEPTH, SECCHI DISK DEPTH",]
if((length(secchi$LAKE_ID))!=0){
secchi<-unique(secchi[c('SAMPLE_DATE','Result.Value')])
secchi<-secchi[!is.na(secchi$Result.Value),]
secchi$SAMPLE_DATE<-as.Date(secchi$SAMPLE_DATE,format="%Y-%m-%d")
secchi$year<-format(secchi$SAMPLE_DATE,"%Y")
secchi$year<-factor(secchi$year,unique(secchi$year))
secchi$day<-format(secchi$SAMPLE_DATE,"%j")
#print the unique years data were collected
unique(secchi$year)


library(ggplot2)
library(RColorBrewer)
  print(ggplot(data=secchi,aes(day,Result.Value)) +
  geom_rect(ymin=-2,ymax=0,xmin=-Inf,xmax=Inf,fill='red',alpha=0.02) +
  geom_rect(ymin=-5,ymax=-2,xmin=-Inf,xmax=Inf,fill='yellow',alpha=0.02) +
  geom_rect(ymin=-Inf,ymax=-5,xmin=-Inf,xmax=Inf,fill='green',alpha=0.02) +
  geom_bar(aes(fill=factor(year)),stat="identity",width=0.05,position="dodge") +
  scale_fill_brewer(palette="Greys") +
  geom_point(colour="black",shape=10,size=6) +
  scale_y_reverse(lim = c((max(secchi$Result.Value)+0.25),0)) +
  theme(legend.title=element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(x="Day of Year", y="Secchi Depth (m)")) 
}
rm(secchi)

```

#Long Term Trend Data
Key to the symbology  
```{r fig.width=3, fig.height=1,echo=FALSE}
library(png)
library(grid)
img <- readPNG("symbology.png")
 grid.raster(img)
 #![](symbology.jpg)
rm(img)
```

```


```{r, echo=FALSE, results='asis'}
library(ggplot2)
library(gridExtra)
library(scales)
#pull long term trend parameters
trend<-temp[temp$Characteristic.Name=='PHOSPHORUS'|
             temp$Characteristic.Name=='ORTHOPHOSPHATE'|
             temp$Characteristic.Name=='CHLOROPHYLL A'|
             temp$Characteristic.Name=='CHLOROPHYLL A (PROBE)'|
             temp$Characteristic.Name=='CHLOROPHYLL A (PROBE) CONCENTRATION, DINOPHYTA (DIATOMS)'|
             temp$Characteristic.Name=='NITROGEN, NITRATE-NITRITE'|
             temp$Characteristic.Name=='INORGANIC NITROGEN (NITRATE AND NITRITE)'|
             temp$Characteristic.Name=='NITROGEN'|
             temp$Characteristic.Name=='NITROGEN, NITRATE (AS N)'|
             temp$Characteristic.Name=='NITROGEN, KJELDAHL, TOTAL'|
             temp$Characteristic.Name=='CALCIUM'|
             temp$Characteristic.Name=='APPARENT COLOR'|
             temp$Characteristic.Name=='COLOR, UNKNOWN'|
             temp$Characteristic.Name=='TRUE COLOR'|
             temp$Characteristic.Name=='PH'|
             temp$Characteristic.Name=='PH FOR COLOR ANALYSIS'|
             temp$Characteristic.Name=='CONDUCTIVITY'|
             temp$Characteristic.Name=='SPECIFIC CONDUCTANCE'|
             temp$Characteristic.Name=='TEMPERATURE, WATER',]
trend<-trend[trend$INFO_TYPE=="OW"|trend$INFO_TYPE=="BS",]
trend<-unique(trend[c('Characteristic.Name','Result.Value','Result.Unit','INFO_TYPE','SAMPLE_NAME','DATA_PROVIDER','SAMPLE_DATE','START_DEPTH','END_DEPTH')])
trend<-trend[!is.na(trend$Result.Value),]
trend<-trend[!is.na(trend$Characteristic.Name),]

if((length(trend$Result.Value))!=0){
params<-unique(trend$Characteristic.Name)
nparams<-length(params)
p<-list()
j<-1

for(i in 1:nparams){
  trend1<-trend[trend$Characteristic.Name==params[i],]
  trend1<-trend1[!is.na(trend1$Characteristic.Name),]
  trend1<-trend1[!is.na(trend1$Result.Value),]
  thresh<-thresholds[thresholds$Characteristic.Name==params[i],]
  if((length(trend1$Result.Value))!=0){
    trend1$year<-format(trend1$SAMPLE_DATE,"%Y")
    trend1$year<-factor(trend1$year,unique(trend1$year))
       if(length(unique(trend1$year))>1){
      p[[j]]<-(ggplot(trend1,aes(SAMPLE_DATE,Result.Value)) +
        geom_rect(ymin=0,ymax=thresh$ystart[1],xmin=-Inf,xmax=Inf,fill='red',alpha=0.02) +
        geom_rect(ymin=thresh$ystart[1],ymax=thresh$yend[1],xmin=-Inf,xmax=Inf,fill='yellow',alpha=0.02) +
        geom_rect(ymin=thresh$yend[1],ymax=Inf,xmin=-Inf,xmax=Inf,fill='green',alpha=0.02) +
        geom_point(aes(color=factor(INFO_TYPE))) +
        theme(axis.title.x = element_blank()) +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
              panel.background = element_blank(), axis.line = element_line(colour = "black"),
              legend.position="none") +
        scale_x_date(labels = date_format("%Y")) +
        labs(title=params[i], y=trend1$Result.Unit[1],colour = ""))
    }
    if(length(unique(trend1$year))<=1){
      p[[j]]<-(ggplot(trend1,aes(SAMPLE_DATE,Result.Value)) +
        geom_rect(ymin=0,ymax=thresh$ystart[1],xmin=-Inf,xmax=Inf,fill='red',alpha=0.02) +
        geom_rect(ymin=thresh$ystart[1],ymax=thresh$yend[1],xmin=-Inf,xmax=Inf,fill='yellow',alpha=0.02) +
        geom_rect(ymin=thresh$yend[1],ymax=Inf,xmin=-Inf,xmax=Inf,fill='green',alpha=0.02) +
        geom_point(aes(color=factor(INFO_TYPE))) +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
              panel.background = element_blank(), axis.line = element_line(colour = "black"),
              legend.position="none") +
        theme(axis.title.x = element_blank()) +
        scale_x_date(labels = date_format("%m-%Y")) +
        labs(title=params[i], y=trend1$Result.Unit[1],colour = ""))
    }
  j<-j+1
  }
  if(i==4|i==8|i==12|i==16|i==nparams){
    do.call(grid.arrange,c(p,ncol=2))
    p<-list()
    j<-1
  }
  rm(list=c('trend1','thresh'))
  }
rm(list=c('i','params','nparams','p','j'))
}
rm(list=c('trend'))
```

# Depth Profiles
```{r, echo=FALSE, results='asis'}
profile<-temp[temp$INFO_TYPE=="DP",]
profile<-unique(profile[c('LAKE_ID','LOCATION_ID','Characteristic.Name','Depth','Result.Value','SAMPLE_DATE')])
profile$Characteristic.Name[profile$Characteristic.Name==""] <- NA
profile<-profile[!is.na(profile$Characteristic.Name),]
if((length(profile$Result.Value))!=0){
library(ggplot2)
  library(gridExtra)
params<-unique(profile$Characteristic.Name)
nparams<-length(params)
p<-list()
for(i in 1:nparams){
  profile1<-profile[profile$Characteristic.Name==params[i],]
  profile1<-profile1[!is.na(profile1$Characteristic.Name),]
  profile1<-profile1[order(profile1$SAMPLE_DATE,profile1$Depth),]
  profile1$SAMPLE_DATE<-format(profile1$SAMPLE_DATE,"%Y.%m.%d")
  profile1$SAMPLE_DATE<-factor(profile1$SAMPLE_DATE,unique(profile1$SAMPLE_DATE))
  p[[i]]<-(ggplot(profile1[order(profile1$Depth,profile1$SAMPLE_DATE),],aes(Result.Value,Depth)) +
    geom_point() +
    geom_path(aes(color=factor(SAMPLE_DATE))) +
    scale_y_reverse(lim = c((max(profile$Depth)+0.25),0)) +
    theme(axis.title.x = element_blank()) +
    labs(title=params[i], y="Depth (m)",colour = "")) 
  rm(list=c('profile1'))
}

do.call(grid.arrange,c(p,ncol=3))
}
rm(list=c('profile','i','params','nparams','p'))
```
